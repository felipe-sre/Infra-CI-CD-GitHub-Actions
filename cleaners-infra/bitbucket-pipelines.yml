# Pipeline Bitbucket para Terraform + Ansible
# Infra: Terraform v1.4.6
# Deploy App: Ansible + Docker + DO Registry

#image: hashicorp/terraform:1.4.6
#
#pipelines:
#  custom:
#    terraform-plan-master:
#      - step:
#          name: Terraform Plan
#          script:
#            - cd terraform/
#            - export DIGITALOCEAN_TOKEN=$DO_API_TOKEN
#            - export AWS_ACCESS_KEY_ID=$DO_SPACES_ACCESS_KEY
#            - export AWS_SECRET_ACCESS_KEY=$DO_SPACES_SECRET_KEY
#            - rm -rf .terraform/ .terraform.lock.hcl
#            - terraform init -reconfigure
#            - terraform plan -var-file="environments/staging.tfvars" -out=tfplan.out
#
#    terraform-apply-master:
#      - step:
#          name: Terraform Apply
#          script:
#            - cd terraform/
#            - export DIGITALOCEAN_TOKEN=$DO_API_TOKEN
#            - export AWS_ACCESS_KEY_ID=$DO_SPACES_ACCESS_KEY
#            - export AWS_SECRET_ACCESS_KEY=$DO_SPACES_SECRET_KEY
#            - rm -rf .terraform/ .terraform.lock.hcl
#            - terraform init -reconfigure
#            - terraform apply -var-file="environments/staging.tfvars" tfplan.out
#
#    deploy-app:
#      - step:
#          name: "Deploy [${APP_NAME}] tag [${IMAGE_TAG}] para [${TARGET_ENV}]"
#          image: python:3.11
#          variables:
#          - name: APP_NAME
#          - name: IMAGE_TAG
#          - name: TARGET_ENV
#            default: "staging"
#            allowed-values: ["staging", "production"]
#          script:
#            - apt update && apt install -y curl git sshpass
#            - export ANSIBLE_HOST_KEY_CHECKING=False
#            - pip install ansible==9.4.0 docker==6.1.3
#            - ansible-galaxy collection install -r infra-nginx-proxies/ansible/requirements.yml
#            - export FULL_IMAGE_PATH="${DOCKER_REPO}/${APP_NAME}:${IMAGE_TAG}"
#            - DOCKER_USERNAME=$DOCKER_USERNAME DOCKER_PASSWORD=$DOCKER_PASSWORD ansible-playbook -i infra-nginx-proxies/ansible/digitalocean.yaml infra-nginx-proxies/ansible/playbooks/deploy_app.yaml --limit "tag_env_${TARGET_ENV}" --extra-vars "app_to_deploy=${APP_NAME} full_image_path=${FULL_IMAGE_PATH}"
#
#    reconfigure-nginx:
#      - variables:
#          - name: TARGET_ENV
#            default: "staging"
#            allowed-values: ["staging", "production"]
#          - name: DOMAIN_NAME
#            default: "example.com"
#          - name: CERTBOT_EMAIL
#            default: "admin@example.com"
#
#      - step:
#          name: "Reconfigurar Nginx + SSL para [${DOMAIN_NAME}]"
#          image: python:3.9
#          script:
#            - apt update && apt install -y curl git sshpass
#            - pip install ansible==9.4.0 docker==6.1.3
#            - ansible-galaxy collection install -r infra-nginx-proxies/ansible/requirements.yml
#            - ansible-playbook \
#                -i infra-nginx-proxies/ansible/inventory/tag_env_${TARGET_ENV}.yml \
#                infra-nginx-proxies/ansible/playbooks/configure_host.yml \
#                --limit "tag_env_${TARGET_ENV}" \
#                --extra-vars "domain_name_var=${DOMAIN_NAME} certbot_email=${CERTBOT_EMAIL}"

pipelines:
  custom:
    deploy-app:
      - step:
          name: "Teste de Gatilho Recebido"
          script:
            - echo "=================================================================="
            - echo " SUCESSO! O gatilho para 'deploy-app' foi recebido e executado. "
            - echo "=================================================================="
            - echo ""Vari√°veis recebidas:" APP_NAME=${APP_NAME}, IMAGE_TAG=${IMAGE_TAG}"